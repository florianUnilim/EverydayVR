<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>A-frame everyday</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <script>
    AFRAME.registerComponent("bench-sit-transition", {
      schema: {
        rig:   { type: "selector" },
        cam:   { type: "selector" },

        lidTop: { type: "selector" },
        lidBot: { type: "selector" },

        phase1:{ type: "selector" },
        phase2:{ type: "selector" },

        seat1: { type: "selector" },
        seat2: { type: "selector" },

        targetYaw: { type: "number", default: 180 },
        rotateMs:  { type: "number", default: 700 },

        preDelayMs:   { type: "number", default: 1300 },
        closeMs:      { type: "number", default: 3000 }, // fermeture 3s
        blackHoldMs:  { type: "number", default: 1000 }, // noir maintenu
        openMs:       { type: "number", default: 2000 }, // ouverture 2s

        move1Ms: { type: "number", default: 650 },

        standCamY: { type: "number", default: 1.6 },
        sitCamY:   { type: "number", default: 0.95 },

        standOnAnyInput: { type: "boolean", default: true },
        standMoveThreshold: { type: "number", default: 0.12 }
      },

      init() {
        this._running = false;
        this._isSitting = false;

        this._camWorld = new THREE.Vector3();
        this._camWorldPrev = new THREE.Vector3();

        this.onClick = () => this.run();
        this.el.addEventListener("click", this.onClick);

        this._tickStand = this._tickStand.bind(this);

        // ZQSD + flèches + espace
        this._onKeyDown = (e) => {
          if (!this._isSitting) return;
          if (!this.data.standOnAnyInput) return;
          const k = (e.key || "").toLowerCase();
          if (["z","q","s","d","arrowup","arrowdown","arrowleft","arrowright"," "].includes(k)) {
            this.standUp();
          }
        };
        window.addEventListener("keydown", this._onKeyDown);

        this.setEyesOpenInstant();
      },

      remove() {
        this.el.removeEventListener("click", this.onClick);
        window.removeEventListener("keydown", this._onKeyDown);
        this.el.sceneEl.removeEventListener("tick", this._tickStand);
      },

      // OUVERT = dehors + invisible
      setEyesOpenInstant() {
        const { lidTop, lidBot } = this.data;
        lidTop.setAttribute("material", "shader: flat; color:#000; transparent:true; opacity:0");
        lidBot.setAttribute("material", "shader: flat; color:#000; transparent:true; opacity:0");
        lidTop.setAttribute("position", "0 1.5 -0.55");
        lidBot.setAttribute("position", "0 -1.5 -0.55");
        lidTop.setAttribute("visible", false);
        lidBot.setAttribute("visible", false);
      },

      run() {
        const d = this.data;
        const { rig, cam, lidTop, lidBot, phase1, phase2, seat1, seat2 } = d;
        if (!rig || !cam || !lidTop || !lidBot || !phase1 || !phase2 || !seat1 || !seat2) return;
        if (this._running) return;
        this._running = true;

        // reset état paupières
        this.setEyesOpenInstant();

        // rotation vers le banc
        rig.setAttribute("animation__turn", {
          property: "rotation",
          to: `0 ${d.targetYaw} 0`,
          dur: d.rotateMs,
          easing: "easeOutCubic"
        });

        // approche assise phase1
        const p1 = seat1.getAttribute("position");
        rig.setAttribute("animation__approach", {
          property: "position",
          to: `${p1.x} ${p1.y} ${p1.z}`,
          dur: d.move1Ms,
          easing: "easeOutCubic"
        });

        const t0 = Math.max(d.rotateMs, d.move1Ms) + d.preDelayMs;

        setTimeout(() => {
          // ========= FERMETURE (extérieur -> centre) =========
          lidTop.setAttribute("visible", true);
          lidBot.setAttribute("visible", true);

          // Force le point de départ (extérieur) AVANT de lancer l'anim
          lidTop.setAttribute("position", "0 1.5 -0.55");
          lidBot.setAttribute("position", "0 -1.5 -0.55");
          lidTop.setAttribute("material", "opacity", 0);
          lidBot.setAttribute("material", "opacity", 0);

          // Anim fermeture : FROM extérieur -> TO centre
          lidTop.setAttribute("animation__closePos", {
            property: "position",
            from: "0 1.5 -0.55",
            to:   "0 0.55 -0.55",
            dur: d.closeMs,
            easing: "easeInOutQuad"
          });
          lidBot.setAttribute("animation__closePos", {
            property: "position",
            from: "0 -1.5 -0.55",
            to:   "0 -0.55 -0.55",
            dur: d.closeMs,
            easing: "easeInOutQuad"
          });

          // Fondu noir (opacity) en même temps
          lidTop.setAttribute("animation__closeOp", {
            property: "material.opacity",
            from: 0,
            to:   1,
            dur: d.closeMs,
            easing: "easeInOutQuad"
          });
          lidBot.setAttribute("animation__closeOp", {
            property: "material.opacity",
            from: 0,
            to:   1,
            dur: d.closeMs,
            easing: "easeInOutQuad"
          });

          // quand c'est fermé + hold -> switch phase2
          setTimeout(() => {
            setTimeout(() => {
              // switch
              phase1.setAttribute("visible", false);
              phase2.setAttribute("visible", true);

              // spawn assis phase2
              const p2 = seat2.getAttribute("position");
              rig.setAttribute("position", `${p2.x} ${p2.y} ${p2.z}`);
              cam.setAttribute("position", `0 ${d.sitCamY} 0`);
              this._isSitting = true;

              cam.object3D.getWorldPosition(this._camWorldPrev);

              // ========= OUVERTURE (centre -> extérieur) =========
              // Force départ centre (au cas où)
              lidTop.setAttribute("position", "0 0.55 -0.55");
              lidBot.setAttribute("position", "0 -0.55 -0.55");
              lidTop.setAttribute("material", "opacity", 1);
              lidBot.setAttribute("material", "opacity", 1);

              lidTop.setAttribute("animation__openPos", {
                property: "position",
                from: "0 0.55 -0.55",
                to:   "0 1.5 -0.55",
                dur: d.openMs,
                easing: "easeOutQuad"
              });
              lidBot.setAttribute("animation__openPos", {
                property: "position",
                from: "0 -0.55 -0.55",
                to:   "0 -1.5 -0.55",
                dur: d.openMs,
                easing: "easeOutQuad"
              });

              lidTop.setAttribute("animation__openOp", {
                property: "material.opacity",
                from: 1,
                to:   0,
                dur: d.openMs,
                easing: "easeOutQuad"
              });
              lidBot.setAttribute("animation__openOp", {
                property: "material.opacity",
                from: 1,
                to:   0,
                dur: d.openMs,
                easing: "easeOutQuad"
              });

              setTimeout(() => {
                lidTop.setAttribute("visible", false);
                lidBot.setAttribute("visible", false);
                this._running = false;
                this.el.sceneEl.addEventListener("tick", this._tickStand);
              }, d.openMs + 80);

            }, d.blackHoldMs);
          }, d.closeMs + 30);

        }, t0);
      },

      _tickStand() {
        if (!this._isSitting) return;
        const d = this.data;
        const cam = d.cam;
        if (!cam) return;

        cam.object3D.getWorldPosition(this._camWorld);
        const dist = this._camWorld.distanceTo(this._camWorldPrev);
        this._camWorldPrev.copy(this._camWorld);

        if (dist > d.standMoveThreshold) this.standUp();
      },

      standUp() {
        if (!this._isSitting) return;
        const d = this.data;
        const cam = d.cam;

        cam.setAttribute("animation__stand", {
          property: "position",
          to: `0 ${d.standCamY} 0`,
          dur: 350,
          easing: "easeOutCubic"
        });

        this._isSitting = false;
        this.el.sceneEl.removeEventListener("tick", this._tickStand);
      }
    });
  </script>
</head>

<body>
  <a-scene>

    <a-assets>
      <img id="fabricColor"  src="/EverydayVR/models/textures/Fabric019_1K-JPG_Color.jpg">
      <img id="fabricRough"  src="/EverydayVR/models/textures/Fabric019_1K-JPG_Roughness.jpg">
      <img id="fabricNormal" src="/EverydayVR/models/textures/Fabric019_1K-JPG_NormalGL.jpg">

      <img id="SnowColor" src="/EverydayVR/models/textures/Snow010A_1K-JPG_Color.jpg">
      <img id="SnowRough" src="/EverydayVR/models/textures/Snow010A_1K-JPG_Roughness.jpg">
      <img id="SnowNormal" src="/EverydayVR/models/textures/Snow010A_1K-JPG_NormalGL.jpg">

      <img id="SnowDirtColor" src="/EverydayVR/models/textures/Snow012_1K-JPG_Color.jpg">
      <img id="SnowDirtRough" src="/EverydayVR/models/textures/Snow012_1K-JPG_Roughness.jpg">
      <img id="SnowDirtNormal" src="/EverydayVR/models/textures/Snow012_1K-JPG_NormalGL.jpg">

      <a-asset-item id="bancModel" src="/EverydayVR/models/banc-no-texture.glb"></a-asset-item>
      <a-asset-item id="Porte-manteau" src="/EverydayVR/models/Coat-Rack.glb"></a-asset-item>

      <img id="montagne-2" src="/images/montagne-2.png">
      <img id="bg-left" src="/images/bg-leftside.png">
      <img id="bg-right" src="/images/bg-rightside.png">
      <img id="bg-en-face" src="/images/bg-en-face.png">
    </a-assets>

    <!-- RIG -->
    <a-entity id="rig" position="0 1.6 4" rotation="0 0 0">
      <a-camera id="cam">
        <a-plane id="lidTop"
          position="0 1.5 -0.55"
          width="4" height="2.6"
          visible="false"
          material="shader: flat; color:#000; transparent:true; opacity:0;">
        </a-plane>

        <a-plane id="lidBot"
          position="0 -1.5 -0.55"
          width="4" height="2.6"
          visible="false"
          material="shader: flat; color:#000; transparent:true; opacity:0;">
        </a-plane>
      </a-camera>

      <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
    </a-entity>

    <a-entity laser-controls="hand: left"  raycaster="objects: .clickable"></a-entity>
    <a-entity laser-controls="hand: right" raycaster="objects: .clickable"></a-entity>

    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>

    <!-- ========= PHASE 1 ========= -->
    <a-entity id="phase1" visible="true">
      <a-sky color="#85754e"></a-sky>

      <a-plane
        height="100" width="100"
        rotation="-90 0 0"
        material="
          shader: standard;
          src: #fabricColor;
          roughnessMap: #fabricRough;
          normalMap: #fabricNormal;
          metalness: 0;
          repeat: 100 100;
          normalScale: 1 1;
        ">
      </a-plane>

      <!-- Banc phase1 (cliquable) -->
      <a-entity
        id="benchModel"
        class="clickable"
        gltf-model="#bancModel"
        position="-1.380 0 -1.500"
        scale="150 150 150"
        bench-sit-transition="
          rig:#rig; cam:#cam;
          lidTop:#lidTop; lidBot:#lidBot;
          phase1:#phase1; phase2:#phase2;
          seat1:#seatPointPhase1; seat2:#seatPointPhase2;
          targetYaw:180;
          preDelayMs:1300;
          closeMs:3000;
          blackHoldMs:1000;
          openMs:2000;
          sitCamY:0.95;
        ">
      </a-entity>

      <a-entity
        id="coatRack"
        gltf-model="#Porte-manteau"
        position="-1.380 0 -0.472"
        scale="2 2 2">
      </a-entity>

      <!-- Assise phase1 (à ajuster si besoin) -->
      <a-entity id="seatPointPhase1" position="-1.380 0.90 -1.45"></a-entity>
    </a-entity>

    <!-- ========= PHASE 2 ========= -->
    <a-entity id="phase2" visible="false">
      <a-sky color="#94CEDB"></a-sky>

      <!-- Banc phase2 NON cliquable -->
      <a-entity
        id="benchModel_phase2"
        gltf-model="#bancModel"
        position="-1.380 0.15 -1.500"
        scale="150 150 150">
      </a-entity>

      <a-image src="#montagne-2" position="0 16.450 -51.368" width="100" height="50"></a-image>
      <a-image src="#bg-en-face" position="0 15.523 47.253" scale="1.04 1.04 1.04" width="100" height="50"></a-image>
      <a-image src="#bg-left" position="-49.942 16.450 -1.698" rotation="0 90 0" width="100" height="50"></a-image>
      <a-image src="#bg-right" position="49.942 16.450 -1.698" rotation="0 -90 0" width="100" height="50"></a-image>

      <!-- Spawn phase2 assis + léger décalage à gauche -->
      <a-entity id="seatPointPhase2" position="-1.520 0.15 -1.500"></a-entity>
    </a-entity>

  </a-scene>
</body>
</html>
